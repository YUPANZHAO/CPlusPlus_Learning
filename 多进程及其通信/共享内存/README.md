## 共享内存

共享内存允许两个或者多个进程共享物理内存的同一块区域（通常被称为段）。由于一个共享内存段会称为一个进程用户空间的一部分，因此这种IPC机制无需内核接入。所有需要做的就是让一个进程将数据复制进共享内存中，并且这部分数据会对其他所有共享同一段的进程可用。

与管道等要求发送进程将数据从用户空间的缓冲区复制进内核内存和接收进程将数据从内核内存复制进用户空间的缓冲区的做法相比，这种IPC技术的速度更快。

## 共享内存的使用步骤

调用 shmget() 创建一个新共享内存段或取得一个既有共享内存段的标识符。这个调用将返回后续调用中需要用到的共享内存标识符。

使用 shmat() 来附上共享内存段，即使该段成为调用进程的虚拟内存的一部分。

此刻在程序中可以像对待其他可用内存那样对待这个共享内存段。为引用这块共享内存，程序需要使用由 shmat() 调用返回的 addr 值，它是一个指向进程的虚拟地址空间中该共享内存段的起点的指针。

调用 shmdt() 来分离共享内存段。在这个调用之后，进程就无法再引用这块共享内存了。这一步是可选的，并且在进程终止时会自动完成这一步。

调用 shmctl() 来删除共享内存段。只有当当前所有附加内存段的进程都与之分离后内存段才会销毁。只需要一个进程执行这一步。

## 共享内存操作命令

**ipcs用法**

* ipcs -a // 打印当前系统中所有的进程间通信方式的信息
* ipcs -m // 打印使用共享内存进行进程间通信的信息
* ipcs -q // 打印使用消息队列进行进程间通信的信息
* ipcs -s // 打印使用信号进行进程间通信的信息

**ipcrm用法**

* ipcrm -M shmkey   // 移除用shmkey创建的共享内存段
* ipcrm -m shmid    // 移除用shmid标识的共享内存段
* ipcrm -Q msqkey   // 移除用msqkey创建的消息队列
* ipcrm -q msqid    // 移除用msqid标识的消息队列
* ipcrm -S semkey   // 移除用semkey创建的信号
* ipcrm -s semid    // 移除用semid标识的信号 

## 共享内存和内存映射的区别

1、共享内存可以直接创建，内存映射需要磁盘文件（匿名映射除外，但匿名映射只能用在有关系的进程间通信）

2、共享内存效率更高，因为不需要跟磁盘文件同步

3、共享内存是操作的同一块内存，而内存映射是每一个进程在自己的虚拟地址空间中有一个独立内存，通过一个文件进行同步

4、进程突然退出，共享内存还存在，而内存映射区消失

5、运行进程的电脑宕机了，存在共享内存中的数据消失了，而内存映射区的数据仍在磁盘中

6、进程退出时，共享内存需要手动删除，而内存映射区会自动销毁